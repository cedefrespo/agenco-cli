#!/usr/bin/env python3
"""
Agenco CLI - Command Line Interface
Manage agents, contexts, and prompts.

Usage:
    agenco                     # Interactive mode
    agenco login               # Login to Agenco
    agenco logout              # Logout from Agenco
    agenco whoami              # Show current user
    agenco agents              # List agents
    agenco agents show <name>  # Show agent details
    agenco agents copy <name>  # Copy agent content to clipboard
    agenco contexts            # List contexts
    agenco contexts show <name># Show context details
    agenco contexts copy <name># Copy context content to clipboard
    agenco prompts             # List prompts
    agenco prompts show <name> # Show prompt details
    agenco prompts copy <name> # Copy prompt to clipboard
    agenco search <query>      # Search across all
    agenco stats               # Show statistics
    
Publish to Agenco Marketplace:
    # From registry (agents.json, contexts.json, prompts.json)
    agenco publish agent marco
    agenco publish context my-docs
    agenco publish prompt fix-bug
    
    # Agent from file (interactive selection in current directory)
    agenco publish agent
    
    # Agent from specific file
    agenco publish agent --file ./system_prompt.md --name my-agent
    
    # Context from current directory (all files)
    agenco publish context
    agenco publish context --dir ./docs --name my-docs
    
    Files are handled automatically:
    - .md, .txt, .json, etc -> bundled as context content
    - .pdf, images, etc    -> uploaded to storage as assets

Authentication:
    Login to avoid passing --token every time:
        agenco login
        agenco publish prompt fix-bug
    
    Or use token directly:
        agenco publish prompt fix-bug --token YOUR_TOKEN
"""

import sys
import os

# Add script directory to path for imports
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from core import (
    get_agents, get_agent, get_agent_content, add_agent, remove_agent,
    get_contexts, get_context, get_context_content, add_context, remove_context,
    get_prompts, get_prompt, get_prompt_content, add_prompt, update_prompt, remove_prompt,
    copy_to_clipboard, search_all, get_stats
)


def print_help():
    """Print help message."""
    print(__doc__)


def cmd_agents(args):
    """Handle agents commands."""
    if not args:
        # List all agents
        agents = get_agents()
        if not agents:
            print("No agents found.")
            return
        print(f"\n Agents ({len(agents)}):\n")
        for agent in agents:
            print(f"  ‚Ä¢ {agent['name']}")
            if agent.get('description'):
                print(f"    {agent['description']}")
        print()
        return
    
    subcmd = args[0]
    
    if subcmd == "show" and len(args) > 1:
        name = args[1]
        agent = get_agent(name)
        if not agent:
            print(f"Agent '{name}' not found.")
            return
        print(f"\n Agent: {agent['name']}")
        print(f"   Description: {agent.get('description', 'N/A')}")
        print(f"   Files:")
        for f in agent.get('files', []):
            print(f"     - {f}")
        print()
    
    elif subcmd == "copy" and len(args) > 1:
        name = args[1]
        content = get_agent_content(name)
        if not content:
            print(f"Agent '{name}' not found.")
            return
        if copy_to_clipboard(content):
            print(f"[OK] Agent '{name}' content copied to clipboard!")
        else:
            print("[ERROR] Failed to copy to clipboard.")
            print(content)
    
    elif subcmd == "add" and len(args) > 2:
        name = args[1]
        files = args[2:]
        try:
            add_agent(name, "", files)
            print(f"[OK] Agent '{name}' added!")
        except ValueError as e:
            print(f"[ERROR] {e}")
    
    elif subcmd == "remove" and len(args) > 1:
        name = args[1]
        if remove_agent(name):
            print(f"[OK] Agent '{name}' removed!")
        else:
            print(f"[ERROR] Agent '{name}' not found.")
    
    else:
        print("Usage: agenco agents [show|copy|add|remove] <name> [files...]")


def cmd_contexts(args):
    """Handle contexts commands."""
    if not args:
        # List all contexts
        contexts = get_contexts()
        if not contexts:
            print("No contexts found.")
            return
        print(f"\nüìö Contexts ({len(contexts)}):\n")
        for ctx in contexts:
            print(f"  ‚Ä¢ {ctx['name']}")
            if ctx.get('description'):
                print(f"    {ctx['description']}")
        print()
        return
    
    subcmd = args[0]
    
    if subcmd == "show" and len(args) > 1:
        name = args[1]
        ctx = get_context(name)
        if not ctx:
            print(f"Context '{name}' not found.")
            return
        print(f"\nüìö Context: {ctx['name']}")
        print(f"   Description: {ctx.get('description', 'N/A')}")
        print(f"   Files:")
        for f in ctx.get('files', []):
            print(f"     - {f}")
        print()
    
    elif subcmd == "copy" and len(args) > 1:
        name = args[1]
        content = get_context_content(name)
        if not content:
            print(f"Context '{name}' not found.")
            return
        if copy_to_clipboard(content):
            print(f"[OK] Context '{name}' content copied to clipboard!")
        else:
            print("[ERROR] Failed to copy to clipboard.")
            print(content)
    
    elif subcmd == "add" and len(args) > 2:
        name = args[1]
        files = args[2:]
        try:
            add_context(name, "", files)
            print(f"[OK] Context '{name}' added!")
        except ValueError as e:
            print(f"[ERROR] {e}")
    
    elif subcmd == "remove" and len(args) > 1:
        name = args[1]
        if remove_context(name):
            print(f"[OK] Context '{name}' removed!")
        else:
            print(f"[ERROR] Context '{name}' not found.")
    
    else:
        print("Usage: agenco contexts [show|copy|add|remove] <name> [files...]")


def cmd_prompts(args):
    """Handle prompts commands."""
    if not args:
        # List all prompts
        prompts = get_prompts()
        if not prompts:
            print("No prompts found.")
            return
        print(f"\nüí¨ Prompts ({len(prompts)}):\n")
        for prompt in prompts:
            print(f"  ‚Ä¢ {prompt['name']}")
            if prompt.get('description'):
                print(f"    {prompt['description']}")
        print()
        return
    
    subcmd = args[0]
    
    if subcmd == "show" and len(args) > 1:
        name = args[1]
        prompt = get_prompt(name)
        if not prompt:
            print(f"Prompt '{name}' not found.")
            return
        print(f"\nüí¨ Prompt: {prompt['name']}")
        print(f"   Description: {prompt.get('description', 'N/A')}")
        print(f"\n   Content:")
        print("   " + "-" * 40)
        for line in prompt.get('prompt', '').split('\n'):
            print(f"   {line}")
        print("   " + "-" * 40)
        print()
    
    elif subcmd == "copy" and len(args) > 1:
        name = args[1]
        content = get_prompt_content(name)
        if content is None:
            print(f"Prompt '{name}' not found.")
            return
        if copy_to_clipboard(content):
            print(f"[OK] Prompt '{name}' copied to clipboard!")
        else:
            print("[ERROR] Failed to copy to clipboard.")
            print(content)
    
    elif subcmd == "add" and len(args) > 2:
        name = args[1]
        prompt_text = " ".join(args[2:])
        try:
            add_prompt(name, "", prompt_text)
            print(f"[OK] Prompt '{name}' added!")
        except ValueError as e:
            print(f"[ERROR] {e}")
    
    elif subcmd == "remove" and len(args) > 1:
        name = args[1]
        if remove_prompt(name):
            print(f"[OK] Prompt '{name}' removed!")
        else:
            print(f"[ERROR] Prompt '{name}' not found.")
    
    else:
        print("Usage: agenco prompts [show|copy|add|remove] <name> [content...]")


def cmd_search(args):
    """Handle search command."""
    if not args:
        print("Usage: agenco search <query>")
        print("Note: Searches in names, descriptions, and file contents")
        return
    
    query = " ".join(args)
    results = search_all(query)
    
    total = sum(len(v) for v in results.values())
    if total == 0:
        print(f"No results found for '{query}'")
        print("Tip: Search looks in names, descriptions, and file contents")
        return
    
    print(f"\nSearch results for '{query}':")
    print("(searching in names, descriptions, and content)\n")
    
    if results["agents"]:
        print(f"   Agents ({len(results['agents'])}):")
        for agent in results["agents"]:
            print(f"    ‚Ä¢ {agent['name']} - {agent.get('description', '')}")
    
    if results["contexts"]:
        print(f"  üìö Contexts ({len(results['contexts'])}):")
        for ctx in results["contexts"]:
            print(f"    ‚Ä¢ {ctx['name']} - {ctx.get('description', '')}")
    
    if results["prompts"]:
        print(f"  üí¨ Prompts ({len(results['prompts'])}):")
        for prompt in results["prompts"]:
            print(f"    ‚Ä¢ {prompt['name']} - {prompt.get('description', '')}")
    
    print()


def cmd_stats(args):
    """Handle stats command."""
    stats = get_stats()
    print("\nüìä Agenco Statistics:\n")
    print(f"   Agents:   {stats['agents']}")
    print(f"  üìö Contexts: {stats['contexts']}")
    print(f"  üí¨ Prompts:  {stats['prompts']}")
    print(f"  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ")
    print(f"  üìÅ Total:    {sum(stats.values())}")
    print()


def cmd_publish(args):
    """Handle publish command - publish to Agenco marketplace.
    
    Modes:
    1. Named resource: agenco publish agent marco (from agents.json)
    2. Directory-based: agenco publish agent (select file in current dir)
    3. Directory context: agenco publish context (publish current dir)
    """
    if not args:
        print("\nUsage: agenco publish <type> [name] [options]")
        print("\nTypes:")
        print("  agent    Publish an agent")
        print("  context  Publish a context")
        print("  prompt   Publish a prompt")
        print("\nModes:")
        print("  1. From registry:  agenco publish agent marco")
        print("     Publishes 'marco' from agents.json")
        print()
        print("  2. From file:      agenco publish agent --file ./system_prompt.md")
        print("     Publishes agent from a .md or .json file")
        print()
        print("  3. From directory: agenco publish context --dir .")
        print("     Publishes all files in directory as a context")
        print("     - .md, .txt, etc -> context content")
        print("     - .pdf, images   -> uploaded to storage")
        print()
        print("Options:")
        print("  --file FILE      Publish agent from specific file (.md or .json)")
        print("  --dir DIR        Publish context from directory (default: current dir)")
        print("  --name NAME      Override resource name")
        print("  --desc DESC      Set description")
        print("  --token TOKEN    Authentication token")
        print("  --api-url URL    API URL (default: https://agt.fly.dev)")
        print("  --no-assets      Skip uploading asset files (for context)")
        print()
        print("Examples:")
        print("  agenco publish agent marco")
        print("  agenco publish agent --file ./my-agent.md --name my-custom-agent")
        print("  agenco publish context --dir ./docs --name project-docs")
        print("  agenco publish context   # publish current directory")
        print("  agenco publish prompt code-review")
        print()
        return
    
    item_type = args[0].lower()
    
    # Parse arguments
    name = None
    token = os.getenv("AGENCO_TOKEN")
    api_url = "https://agt.fly.dev"
    file_path = None
    dir_path = None
    description = None
    include_assets = True
    
    i = 1
    while i < len(args):
        if args[i] == "--token" and i + 1 < len(args):
            token = args[i + 1]
            i += 2
        elif args[i] == "--api-url" and i + 1 < len(args):
            api_url = args[i + 1]
            i += 2
        elif args[i] == "--file" and i + 1 < len(args):
            file_path = args[i + 1]
            i += 2
        elif args[i] == "--dir" and i + 1 < len(args):
            dir_path = args[i + 1]
            i += 2
        elif args[i] == "--name" and i + 1 < len(args):
            name = args[i + 1]
            i += 2
        elif args[i] == "--desc" and i + 1 < len(args):
            description = args[i + 1]
            i += 2
        elif args[i] == "--no-assets":
            include_assets = False
            i += 1
        elif not args[i].startswith("--") and name is None:
            name = args[i]
            i += 1
        else:
            i += 1
    
    try:
        # AGENT publishing
        if item_type == "agent":
            if file_path:
                # Publish from file
                from core import publish_agent_from_file
                print(f"\n[Publishing] Publishing agent from file '{file_path}'...")
                result = publish_agent_from_file(file_path, name=name, description=description, api_url=api_url, token=token)
            elif name:
                # Publish from registry
                from core import publish_agent
                print(f"\n[Publishing] Publishing agent '{name}' to Agenco marketplace...")
                result = publish_agent(name, api_url=api_url, token=token)
            else:
                # Interactive: select file in current directory
                cmd_publish_agent_interactive(api_url, token, name, description)
                return
        
        # CONTEXT publishing
        elif item_type == "context":
            if dir_path or (not name and not file_path):
                # Publish from directory
                from core import publish_context_from_directory
                target_dir = dir_path or "."
                print(f"\n[Publishing] Publishing context from directory '{target_dir}'...")
                
                # Show what will be published
                from core import get_directory_files
                files_info = get_directory_files(target_dir)
                
                print(f"\n  Directory: {files_info['directory']}")
                if files_info['text_files']:
                    print(f"  Text files ({len(files_info['text_files'])}):")
                    for f in files_info['text_files'][:10]:
                        print(f"    - {f['name']}")
                    if len(files_info['text_files']) > 10:
                        print(f"    ... and {len(files_info['text_files']) - 10} more")
                
                if files_info['asset_files']:
                    print(f"  Asset files ({len(files_info['asset_files'])}):")
                    for f in files_info['asset_files'][:5]:
                        print(f"    - {f['name']} (will be uploaded to storage)")
                    if len(files_info['asset_files']) > 5:
                        print(f"    ... and {len(files_info['asset_files']) - 5} more")
                
                if not files_info['text_files'] and not files_info['asset_files']:
                    print("\n[ERROR] No publishable files found in directory")
                    return
                
                # Confirm
                confirm = input("\nPublish this context? [y/N]: ").strip().lower()
                if confirm != 'y':
                    print("[Cancelled]")
                    return
                
                result = publish_context_from_directory(
                    directory=target_dir, 
                    name=name, 
                    description=description, 
                    api_url=api_url, 
                    token=token,
                    include_assets=include_assets
                )
            elif name:
                # Publish from registry
                from core import publish_context
                print(f"\n[Publishing] Publishing context '{name}' to Agenco marketplace...")
                result = publish_context(name, api_url=api_url, token=token)
            else:
                print("[ERROR] Please provide a context name or use --dir")
                return
        
        # PROMPT publishing
        elif item_type == "prompt":
            if name:
                from core import publish_prompt
                print(f"\n[Publishing] Publishing prompt '{name}' to Agenco marketplace...")
                result = publish_prompt(name, api_url=api_url, token=token)
            else:
                print("[ERROR] Please provide a prompt name")
                print("Usage: agenco publish prompt <name>")
                return
        
        else:
            print(f"\n[ERROR] Unknown type: {item_type}")
            print("   Valid types: agent, context, prompt")
            return
        
        # Success output
        print(f"\n[OK] Successfully published!")
        if result.get("id"):
            print(f"   ID: {result['id']}")
        if result.get("url"):
            print(f"   URL: {result['url']}")
        if result.get("name"):
            print(f"   Name: {result['name']}")
        print()
        
    except ValueError as e:
        print(f"\n[ERROR] Error: {str(e)}")
        print()
    except Exception as e:
        print(f"\n[ERROR] Failed to publish: {str(e)}")
        print()


def cmd_publish_agent_interactive(api_url, token, name=None, description=None):
    """Interactive agent publishing - select file from current directory."""
    from pathlib import Path
    from core import publish_agent_from_file
    
    cwd = Path.cwd()
    
    # Find .md and .json files
    valid_files = []
    for item in cwd.iterdir():
        if item.is_file() and item.suffix.lower() in {'.md', '.json'} and not item.name.startswith('.'):
            valid_files.append(item)
    
    if not valid_files:
        print(f"\n[ERROR] No .md or .json files found in {cwd}")
        print("   Please navigate to a directory with agent files or use --file")
        return
    
    # Sort by name
    valid_files.sort(key=lambda x: x.name)
    
    print(f"\n[Agent] Select a file to publish as agent:")
    print(f"   Directory: {cwd}\n")
    
    for idx, f in enumerate(valid_files, 1):
        size = f.stat().st_size
        size_str = f"{size / 1024:.1f} KB" if size > 1024 else f"{size} B"
        print(f"   [{idx}] {f.name} ({size_str})")
    
    print(f"   [0] Cancel")
    print()
    
    try:
        choice = input("Select file: ").strip()
        choice_num = int(choice)
        
        if choice_num == 0:
            print("[Cancelled]")
            return
        
        if 1 <= choice_num <= len(valid_files):
            selected_file = valid_files[choice_num - 1]
            
            # Ask for name if not provided
            if not name:
                default_name = selected_file.stem
                name_input = input(f"Agent name [{default_name}]: ").strip()
                name = name_input if name_input else default_name
            
            # Ask for description if not provided
            if not description:
                desc_input = input("Description (optional): ").strip()
                description = desc_input if desc_input else None
            
            print(f"\n[Publishing] Publishing agent from '{selected_file.name}'...")
            result = publish_agent_from_file(
                str(selected_file), 
                name=name, 
                description=description, 
                api_url=api_url, 
                token=token
            )
            
            print(f"\n[OK] Successfully published!")
            if result.get("id"):
                print(f"   ID: {result['id']}")
            if result.get("url"):
                print(f"   URL: {result['url']}")
            print()
        else:
            print("[ERROR] Invalid selection")
            
    except ValueError:
        print("[ERROR] Please enter a number")
    except Exception as e:
        print(f"\n[ERROR] Failed to publish: {str(e)}")


def interactive_mode():
    """Run interactive mode - delegates to UI module."""
    try:
        from ui import run_interactive
        run_interactive()
    except ImportError:
        print("Interactive UI not available. Use command-line arguments.")
        print_help()


def cmd_login(args):
    """Handle 'agenco login' command."""
    import getpass
    from core import login
    
    # Parse optional args
    api_url = "https://agt.fly.dev"
    email = None
    
    i = 0
    while i < len(args):
        if args[i] == "--api-url" and i + 1 < len(args):
            api_url = args[i + 1]
            i += 2
        elif args[i] == "--email" and i + 1 < len(args):
            email = args[i + 1]
            i += 2
        else:
            i += 1
    
    print()
    print("[Login] Login to Agenco")
    print()
    
    # Get credentials
    if not email:
        email = input("Email: ").strip()
    
    password = getpass.getpass("Password: ")
    
    try:
        result = login(email, password, api_url)
        user = result.get("user", {})
        
        print()
        print(f"[OK] Logged in successfully as {user.get('name', email)}")
        print(f"   Email: {user.get('email')}")
        print()
        print("You can now use 'agenco publish' without --token")
        print()
        
    except Exception as e:
        print()
        print(f"[ERROR] Login failed: {str(e)}")
        print()


def cmd_logout(args):
    """Handle 'agenco logout' command."""
    from core import logout, get_current_user
    
    user = get_current_user()
    if not user:
        print()
        print("[INFO]  Not logged in")
        print()
        return
    
    logout()
    print()
    print(f"[OK] Logged out from {user.get('email')}")
    print()


def cmd_whoami(args):
    """Handle 'agenco whoami' command."""
    from core import get_current_user, get_config
    
    user = get_current_user()
    if not user:
        print()
        print("[INFO]  Not logged in")
        print()
        print("Run 'agenco login' to authenticate")
        print()
        return
    
    config = get_config()
    
    print()
    print("[User] Current User")
    print()
    print(f"   Name: {user.get('name', 'N/A')}")
    print(f"   Email: {user.get('email')}")
    print(f"   ID: {user.get('id', 'N/A')}")
    print(f"   API: {config.get('api_url', 'N/A')}")
    print()


def main():
    """Main entry point."""
    args = sys.argv[1:]
    
    if not args:
        interactive_mode()
        return
    
    cmd = args[0]
    cmd_args = args[1:]
    
    if cmd in ["-h", "--help", "help"]:
        print_help()
    elif cmd == "login":
        cmd_login(cmd_args)
    elif cmd == "logout":
        cmd_logout(cmd_args)
    elif cmd == "whoami":
        cmd_whoami(cmd_args)
    elif cmd == "agents":
        cmd_agents(cmd_args)
    elif cmd == "contexts":
        cmd_contexts(cmd_args)
    elif cmd == "prompts":
        cmd_prompts(cmd_args)
    elif cmd == "search":
        cmd_search(cmd_args)
    elif cmd == "stats":
        cmd_stats(cmd_args)
    elif cmd == "publish":
        cmd_publish(cmd_args)
    else:
        print(f"Unknown command: {cmd}")
        print_help()


if __name__ == "__main__":
    main()
