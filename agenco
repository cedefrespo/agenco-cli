#!/usr/bin/env python3
"""
Agenco CLI - Command Line Interface
Manage agents, contexts, and prompts.

Usage:
    agenco                     # Interactive mode
    agenco agents              # List agents
    agenco agents show <name>  # Show agent details
    agenco agents copy <name>  # Copy agent content to clipboard
    agenco contexts            # List contexts
    agenco contexts show <name># Show context details
    agenco contexts copy <name># Copy context content to clipboard
    agenco prompts             # List prompts
    agenco prompts show <name> # Show prompt details
    agenco prompts copy <name> # Copy prompt to clipboard
    agenco search <query>      # Search across all
    agenco stats               # Show statistics
    agenco publish <type> <name> # Publish to Agenco marketplace
"""

import sys
import os

# Add script directory to path for imports
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from core import (
    get_agents, get_agent, get_agent_content, add_agent, remove_agent,
    get_contexts, get_context, get_context_content, add_context, remove_context,
    get_prompts, get_prompt, get_prompt_content, add_prompt, update_prompt, remove_prompt,
    copy_to_clipboard, search_all, get_stats
)


def print_help():
    """Print help message."""
    print(__doc__)


def cmd_agents(args):
    """Handle agents commands."""
    if not args:
        # List all agents
        agents = get_agents()
        if not agents:
            print("No agents found.")
            return
        print(f"\nğŸ“¦ Agents ({len(agents)}):\n")
        for agent in agents:
            print(f"  â€¢ {agent['name']}")
            if agent.get('description'):
                print(f"    {agent['description']}")
        print()
        return
    
    subcmd = args[0]
    
    if subcmd == "show" and len(args) > 1:
        name = args[1]
        agent = get_agent(name)
        if not agent:
            print(f"Agent '{name}' not found.")
            return
        print(f"\nğŸ“¦ Agent: {agent['name']}")
        print(f"   Description: {agent.get('description', 'N/A')}")
        print(f"   Files:")
        for f in agent.get('files', []):
            print(f"     - {f}")
        print()
    
    elif subcmd == "copy" and len(args) > 1:
        name = args[1]
        content = get_agent_content(name)
        if not content:
            print(f"Agent '{name}' not found.")
            return
        if copy_to_clipboard(content):
            print(f"âœ… Agent '{name}' content copied to clipboard!")
        else:
            print("âŒ Failed to copy to clipboard.")
            print(content)
    
    elif subcmd == "add" and len(args) > 2:
        name = args[1]
        files = args[2:]
        try:
            add_agent(name, "", files)
            print(f"âœ… Agent '{name}' added!")
        except ValueError as e:
            print(f"âŒ {e}")
    
    elif subcmd == "remove" and len(args) > 1:
        name = args[1]
        if remove_agent(name):
            print(f"âœ… Agent '{name}' removed!")
        else:
            print(f"âŒ Agent '{name}' not found.")
    
    else:
        print("Usage: agenco agents [show|copy|add|remove] <name> [files...]")


def cmd_contexts(args):
    """Handle contexts commands."""
    if not args:
        # List all contexts
        contexts = get_contexts()
        if not contexts:
            print("No contexts found.")
            return
        print(f"\nğŸ“š Contexts ({len(contexts)}):\n")
        for ctx in contexts:
            print(f"  â€¢ {ctx['name']}")
            if ctx.get('description'):
                print(f"    {ctx['description']}")
        print()
        return
    
    subcmd = args[0]
    
    if subcmd == "show" and len(args) > 1:
        name = args[1]
        ctx = get_context(name)
        if not ctx:
            print(f"Context '{name}' not found.")
            return
        print(f"\nğŸ“š Context: {ctx['name']}")
        print(f"   Description: {ctx.get('description', 'N/A')}")
        print(f"   Files:")
        for f in ctx.get('files', []):
            print(f"     - {f}")
        print()
    
    elif subcmd == "copy" and len(args) > 1:
        name = args[1]
        content = get_context_content(name)
        if not content:
            print(f"Context '{name}' not found.")
            return
        if copy_to_clipboard(content):
            print(f"âœ… Context '{name}' content copied to clipboard!")
        else:
            print("âŒ Failed to copy to clipboard.")
            print(content)
    
    elif subcmd == "add" and len(args) > 2:
        name = args[1]
        files = args[2:]
        try:
            add_context(name, "", files)
            print(f"âœ… Context '{name}' added!")
        except ValueError as e:
            print(f"âŒ {e}")
    
    elif subcmd == "remove" and len(args) > 1:
        name = args[1]
        if remove_context(name):
            print(f"âœ… Context '{name}' removed!")
        else:
            print(f"âŒ Context '{name}' not found.")
    
    else:
        print("Usage: agenco contexts [show|copy|add|remove] <name> [files...]")


def cmd_prompts(args):
    """Handle prompts commands."""
    if not args:
        # List all prompts
        prompts = get_prompts()
        if not prompts:
            print("No prompts found.")
            return
        print(f"\nğŸ’¬ Prompts ({len(prompts)}):\n")
        for prompt in prompts:
            print(f"  â€¢ {prompt['name']}")
            if prompt.get('description'):
                print(f"    {prompt['description']}")
        print()
        return
    
    subcmd = args[0]
    
    if subcmd == "show" and len(args) > 1:
        name = args[1]
        prompt = get_prompt(name)
        if not prompt:
            print(f"Prompt '{name}' not found.")
            return
        print(f"\nğŸ’¬ Prompt: {prompt['name']}")
        print(f"   Description: {prompt.get('description', 'N/A')}")
        print(f"\n   Content:")
        print("   " + "-" * 40)
        for line in prompt.get('prompt', '').split('\n'):
            print(f"   {line}")
        print("   " + "-" * 40)
        print()
    
    elif subcmd == "copy" and len(args) > 1:
        name = args[1]
        content = get_prompt_content(name)
        if content is None:
            print(f"Prompt '{name}' not found.")
            return
        if copy_to_clipboard(content):
            print(f"âœ… Prompt '{name}' copied to clipboard!")
        else:
            print("âŒ Failed to copy to clipboard.")
            print(content)
    
    elif subcmd == "add" and len(args) > 2:
        name = args[1]
        prompt_text = " ".join(args[2:])
        try:
            add_prompt(name, "", prompt_text)
            print(f"âœ… Prompt '{name}' added!")
        except ValueError as e:
            print(f"âŒ {e}")
    
    elif subcmd == "remove" and len(args) > 1:
        name = args[1]
        if remove_prompt(name):
            print(f"âœ… Prompt '{name}' removed!")
        else:
            print(f"âŒ Prompt '{name}' not found.")
    
    else:
        print("Usage: agenco prompts [show|copy|add|remove] <name> [content...]")


def cmd_search(args):
    """Handle search command."""
    if not args:
        print("Usage: agenco search <query>")
        print("Note: Searches in names, descriptions, and file contents")
        return
    
    query = " ".join(args)
    results = search_all(query)
    
    total = sum(len(v) for v in results.values())
    if total == 0:
        print(f"No results found for '{query}'")
        print("Tip: Search looks in names, descriptions, and file contents")
        return
    
    print(f"\nSearch results for '{query}':")
    print("(searching in names, descriptions, and content)\n")
    
    if results["agents"]:
        print(f"  ğŸ“¦ Agents ({len(results['agents'])}):")
        for agent in results["agents"]:
            print(f"    â€¢ {agent['name']} - {agent.get('description', '')}")
    
    if results["contexts"]:
        print(f"  ğŸ“š Contexts ({len(results['contexts'])}):")
        for ctx in results["contexts"]:
            print(f"    â€¢ {ctx['name']} - {ctx.get('description', '')}")
    
    if results["prompts"]:
        print(f"  ğŸ’¬ Prompts ({len(results['prompts'])}):")
        for prompt in results["prompts"]:
            print(f"    â€¢ {prompt['name']} - {prompt.get('description', '')}")
    
    print()


def cmd_stats(args):
    """Handle stats command."""
    stats = get_stats()
    print("\nğŸ“Š Agenco Statistics:\n")
    print(f"  ğŸ“¦ Agents:   {stats['agents']}")
    print(f"  ğŸ“š Contexts: {stats['contexts']}")
    print(f"  ğŸ’¬ Prompts:  {stats['prompts']}")
    print(f"  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€")
    print(f"  ğŸ“ Total:    {sum(stats.values())}")
    print()


def cmd_publish(args):
    """Handle publish command - publish to Agenco marketplace."""
    if not args or len(args) < 2:
        print("\nUsage: agenco publish <type> <name> [--token TOKEN] [--api-url URL]")
        print("\nExamples:")
        print("  agenco publish agent marco")
        print("  agenco publish context ux-patterns")
        print("  agenco publish prompt code-review")
        print("  agenco publish agent marco --token abc123")
        print("  agenco publish context ux-patterns --api-url http://localhost:8080")
        print("\nOptions:")
        print("  --token TOKEN    Authentication token (if not set, will look for AGENCO_TOKEN env var)")
        print("  --api-url URL    API URL (default: https://api.agenco.dev)")
        print()
        return
    
    item_type = args[0].lower()
    name = args[1]
    
    # Parse optional arguments
    token = os.getenv("AGENCO_TOKEN")
    api_url = "https://api.agenco.dev"
    
    i = 2
    while i < len(args):
        if args[i] == "--token" and i + 1 < len(args):
            token = args[i + 1]
            i += 2
        elif args[i] == "--api-url" and i + 1 < len(args):
            api_url = args[i + 1]
            i += 2
        else:
            i += 1
    
    if not token:
        print("\nâš ï¸  No authentication token provided.")
        print("Set AGENCO_TOKEN environment variable or use --token flag.")
        print("Example: export AGENCO_TOKEN='your-token-here'")
        print()
        return
    
    try:
        print(f"\nğŸš€ Publishing {item_type} '{name}' to Agenco marketplace...")
        
        if item_type == "agent":
            from core import publish_agent
            result = publish_agent(name, api_url=api_url, token=token)
        elif item_type == "context":
            from core import publish_context
            result = publish_context(name, api_url=api_url, token=token)
        elif item_type == "prompt":
            from core import publish_prompt
            result = publish_prompt(name, api_url=api_url, token=token)
        else:
            print(f"\nâŒ Unknown type: {item_type}")
            print("   Valid types: agent, context, prompt")
            return
        
        print(f"\nâœ… Successfully published '{name}'!")
        if result.get("id"):
            print(f"   ID: {result['id']}")
        if result.get("url"):
            print(f"   URL: {result['url']}")
        print()
        
    except ValueError as e:
        print(f"\nâŒ Error: {str(e)}")
        print()
    except Exception as e:
        print(f"\nâŒ Failed to publish: {str(e)}")
        print()


def interactive_mode():
    """Run interactive mode - delegates to UI module."""
    try:
        from ui import run_interactive
        run_interactive()
    except ImportError:
        print("Interactive UI not available. Use command-line arguments.")
        print_help()


def main():
    """Main entry point."""
    args = sys.argv[1:]
    
    if not args:
        interactive_mode()
        return
    
    cmd = args[0]
    cmd_args = args[1:]
    
    if cmd in ["-h", "--help", "help"]:
        print_help()
    elif cmd == "agents":
        cmd_agents(cmd_args)
    elif cmd == "contexts":
        cmd_contexts(cmd_args)
    elif cmd == "prompts":
        cmd_prompts(cmd_args)
    elif cmd == "search":
        cmd_search(cmd_args)
    elif cmd == "stats":
        cmd_stats(cmd_args)
    elif cmd == "publish":
        cmd_publish(cmd_args)
    else:
        print(f"Unknown command: {cmd}")
        print_help()


if __name__ == "__main__":
    main()
